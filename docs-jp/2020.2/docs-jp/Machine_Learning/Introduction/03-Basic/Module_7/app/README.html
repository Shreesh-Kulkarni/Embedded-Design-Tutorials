


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../../../../../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../../../../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>

  
  
  
  

  
      <script type="text/javascript" src="../../../../../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../../../../../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/header-footer.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="header parbase aem-GridColumn aem-GridColumn--default--12">
								<noindex>
									<header data-component="header">
										<nav class="navbar navbar-default aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid main-nav">
													<div class="row">
														<div class="col-xs-12">
															<div class="logo-column">
																<div class="logo">
																	<a href="https://www.xilinx.com/">
																	<img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc"/>
																	</a>
																</div>
															</div>
															<div class="navbar-column">
																<div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
																	<div class="mobile-search-container">
																		<div id="headerSearchBox" class="headerSearch"
																			data-component="header-search"
																			data-redirect-if-empty="false"
																			data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																			data-coveo-organization-id="xilinxcomprode2rjoqok">
																			<div class='coveo-search-section'>
																				<div class="CoveoAnalytics" data-search-hub="Site"></div>
																				<ul class="dropdown-menu options">
																					<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																						<a href="#">
																						All</a>
																					</li>
																					<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com//products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Silicon Devices</a>
																					</li>
																					<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com//products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Boards and Kits</a>
																					</li>
																					<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com//products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																						<a href="#">
																						Intellectual Property</a>
																					</li>
																					<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																						<a href="#">
																						Support</a>
																						<ul>
																							<li data-label="Documentation" data-action-link="https://www.xilinx.com//support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																								<a href="#">
																								Documentation</a>
																							</li>
																							<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com//support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																								<a href="#">
																								Knowledge Base</a>
																							</li>
																							<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																								<a href="#">
																								Community Forums</a>
																							</li>
																						</ul>
																					</li>
																					<li data-label="Partners" data-action-link="https://www.xilinx.com//alliance/member-keyword-search.html" data-search-hub="Partner">
																						<a href="#">
																						Partners</a>
																					</li>
																					<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																						<a href="#">
																						Videos</a>
																					</li>
																					<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																						<a href="#">
																						Press</a>
																					</li>
																				</ul>
																				<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																				<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																			</div>
																		</div>
																	</div>
																	<ul class="nav navbar-nav nav-justified">
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/applications.html">
																			Applications</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/products/silicon-devices.html">
																			Products</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://developer.xilinx.com/">
																			Developers</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/support.html">
																			Support</a>
																		</li>
																		<li class="accordion-toggle-icons" data-component="toggle-dropdown">
																			<a href="https://www.xilinx.com/about/company-overview.html">
																			About</a>
																		</li>
																	</ul>
																</div>
															</div>
															<script type="text/javascript" src="../../../../../_static/js/gtm.js"></script>
															<!--<div class="mini-nav">
																<button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
																<span></span>
																<span></span>
																<span></span>
																<span></span>
																</button>
																<ul class="list-inline">
																	<li class="dropdown user-menu">
																		<button data-toggle="dropdown">
																		<span class="sr-only">Account</span>
																		<span class="fas fa-user"></span>
																		</button>
																		<ul class="dropdown-menu">
																			<li>
																				<a href="https://www.xilinx.com/myprofile/subscriptions.html">
																				My Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/registration/create-account.html">
																				Create Account</a>
																			</li>
																			<li>
																				<a href="https://www.xilinx.com/bin/protected/en/signout">
																				Sign Out</a>
																			</li>
																		</ul>
																	</li>
																	<li class="hidden-xs">
																		<button data-function="search-toggle">
																		<span class="sr-only">Search</span>
																		<span class="far fa-search"></span>
																		</button>
																	</li>
																</ul>
															</div>
															-->
															<div class="search-container">
																<div id="headerSearchBox" class="headerSearch"
																	data-component="header-search"
																	data-redirect-if-empty="false"
																	data-coveo-access-token="xxa237d4dd-f0aa-47fc-9baa-af9121851b33"
																	data-coveo-organization-id="xilinxcomprode2rjoqok">
																	<div class='coveo-search-section'>
																		<div class="CoveoAnalytics" data-search-hub="Site"></div>
																		<ul class="dropdown-menu options">
																			<li class="option" data-label="All" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-search-hub="Site">
																				<a href="#">
																				All</a>
																			</li>
																			<li data-label="Silicon Devices" data-action-link="https://www.xilinx.com/products/silicon-devices/si-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Silicon Devices</a>
																			</li>
																			<li data-label="Boards and Kits" data-action-link="https://www.xilinx.com/products/boards-and-kits/bk-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Boards and Kits</a>
																			</li>
																			<li data-label="Intellectual Property" data-action-link="https://www.xilinx.com/products/intellectual-property/ip-keyword-search.html" data-search-hub="Product">
																				<a href="#">
																				Intellectual Property</a>
																			</li>
																			<li data-label="Support" class="option" data-action-link="https://www.xilinx.com/search/support-keyword-search.html" data-search-hub="Support">
																				<a href="#">
																				Support</a>
																				<ul>
																					<li data-label="Documentation" data-action-link="https://www.xilinx.com/support/documentation-navigation/documentation-keyword-search.html" data-search-hub="Document">
																						<a href="#">
																						Documentation</a>
																					</li>
																					<li data-label="Knowledge Base" data-action-link="https://www.xilinx.com/support/answer-navigation/answer-keyword-search.html" data-search-hub="AnswerRecord">
																						<a href="#">
																						Knowledge Base</a>
																					</li>
																					<li data-label="Community Forums" data-action-link="https://www.xilinx.com/search/forums-keyword-search.html" data-search-hub="Forums">
																						<a href="#">
																						Community Forums</a>
																					</li>
																				</ul>
																			</li>
																			<li data-label="Partners" data-action-link="https://www.xilinx.com/alliance/member-keyword-search.html" data-search-hub="Partner">
																				<a href="#">
																				Partners</a>
																			</li>
																			<li data-label="Videos" data-action-link="https://www.xilinx.com/video/video-keyword-search.html" data-search-hub="Video">
																				<a href="#">
																				Videos</a>
																			</li>
																			<li data-label="Press" data-action-link="https://www.xilinx.com/search/press-keyword-search.html" data-search-hub="Press">
																				<a href="#">
																				Press</a>
																			</li>
																		</ul>
																		<a href="#" class="btn dropdown-toggle value" data-toggle="dropdown"></a>
																		<div class="CoveoSearchbox" data-id="coveosearchbox" data-action-link="https://www.xilinx.com/search/site-keyword-search.html" data-placeholder="Search Xilinx"></div>
																	</div>
																</div>
																<button data-function="search-toggle">
																<span class="sr-only">Search</span>
																<span class="far fa-times"></span>
																</button>
															</div>
														</div>
													</div>
												</div>
											</div>
										</nav>
									</header>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home" alt="Documentation Home"> Vitis チュートリアル
          

          
          </a>

          
            
            
              <div class="version">
                2020.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption"><span class="caption-text">English version</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/master/docs/index.html">Master</a></li>
</ul>
<p class="caption"><span class="caption-text">入門</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Getting_Started/Vitis/README.html">Vitis フロー 101 チュートリアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Getting_Started/Vitis_HLS/README.html">Vitis HLS の解析および最適化</a></li>
</ul>
<p class="caption"><span class="caption-text">機械学習 (英語版)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Introduction to Machine Learning with Vitis AI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html#design-tutorials">Design Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html#feature-tutorials">Feature Tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">アクセラレーション</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Hardware_Accelerators/README.html">Vitis ハードウェア アクセラレータの概要</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Hardware_Accelerators/README.html#id1">設計チュートリアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Hardware_Accelerators/README.html#id2">機能チュートリアル</a></li>
</ul>
<p class="caption"><span class="caption-text">AI エンジン開発 (英語版)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../AI_Engine_Development/README.html">Design Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../AI_Engine_Development/README.html#feature-tutorials">Feature Tutorials</a></li>
</ul>
<p class="caption"><span class="caption-text">プラットフォーム作成チュートリアル</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Vitis_Platform_Creation/README.html">プラットフォームの作成</a></li>
</ul>
<p class="caption"><span class="caption-text">XRT および Vitis システム最適化</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Runtime_and_System_Optimization/README.html">設計チュートリアル</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../Runtime_and_System_Optimization/README.html#id2">機能チュートリアル</a></li>
</ul>
<p class="caption"><span class="caption-text">バージョン</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Vitis-Tutorials/2020-1/docs/README.html">2020.1</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/Xilinx/Vitis-Tutorials/blob/Vitis-Tutorials-2019.2-Hotfix1/README.md">2019.2</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../../../../../_sources/Machine_Learning/Introduction/03-Basic/Module_7/app/README.md.txt"
						rel="nofollow">Show Source</a></li>
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Vitis チュートリアル</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Migrate from OpenCV to HLS kernel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../../_sources/Machine_Learning/Introduction/03-Basic/Module_7/app/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="migrate-from-opencv-to-hls-kernel">
<h1>Migrate from OpenCV to HLS kernel<a class="headerlink" href="#migrate-from-opencv-to-hls-kernel" title="Permalink to this headline">¶</a></h1>
<hr class="docutils" />
<p>Use high resolution video input to demonstrate the kernel’s acceleration performance. In this case, the input video is set to 2304x1296 and the bottleneck should obviously be color conversion and resizing. So before you start experimenting, please make sure that the USB camera you are using can be set to that resolution.</p>
</div>
<hr class="docutils" />
<div class="section" id="hardware">
<h1>Hardware<a class="headerlink" href="#hardware" title="Permalink to this headline">¶</a></h1>
<p>dpu.xclbin located at /mnt/dpu.xclbin, which contains two kernels.
Kernel: pre_processor
Kernel: dpu_xrt_top</p>
<ul class="simple">
<li><p>pre_processor
For this kernel, we need to prepare 2 buffers to read the output data. One is the full image according to the input resolution you set and the other one is resized. In this case, it’s set to 480*360, which is required by the refindet model.</p></li>
<li><p>dpu_xrt_top
Using the API of the vitis ai library to implement the DPU encapsulation, we only need to focus on the preparation of the input image, and the development of the upper level application.</p></li>
<li><p>The directory struction is shown as below</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>.
├── build
│   ├── dpu_conf.vh                 #dpu config file
│   ├── Makefile                    #Makefile for integrated
│   ├── preprocessor_config.ini     #HLS kernel config file
│   └── prj_config_104_2dpu         #config file for integrated
├── flash_sd_card.sh                #script for generate the OS image
└── src                             #kernel source codes
    ├── pre_processor.cpp           #kernel implementation code
    └── pre_processor.h             #kernel header file
</pre></div>
</div>
<ul class="simple">
<li><p>Kernel function
Inspect the kernel function in <a class="reference external" href="../kernel/src/pre_processor.h">pre_processor.h</a>, the arguments description as below.</p></li>
</ul>
<p>augument|description
—|—|
image_in|           The input buffer from host
image_out|          the resize image(640*360) output buffer from device
image_out_full|     The full image(1080p) output buffer from device
width_in|           The input image data width 3840
height_in|          The input image data height 1526
width_out|          The width of resize output image
height_out|         The height of resize output image</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">pre_processor</span><span class="p">(</span><span class="n">ap_uint</span><span class="o">&lt;</span><span class="n">AXI_WIDTH</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">image_in</span><span class="p">,</span> <span class="n">ap_uint</span><span class="o">&lt;</span><span class="n">AXI_WIDTH</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">image_out</span><span class="p">,</span>
		<span class="n">ap_uint</span><span class="o">&lt;</span><span class="n">AXI_WIDTH</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">image_out_full</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width_in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height_in</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">width_out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height_out</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="how-to-program-with-kernel-pre-processor">
<h1>How to program with kernel pre-processor<a class="headerlink" href="#how-to-program-with-kernel-pre-processor" title="Permalink to this headline">¶</a></h1>
<p>For convient use the kernel, The methods of OpenCL are encapsulated in to class XilinxOcl, for the detail you can refer to <a class="reference external" href="../my_V4l2s/include/xcl2.hpp">xcl2.hpp</a></p>
<p>Take <a class="reference external" href="../my_V4l2s/test/test_hls_kernel.cpp">test_hls_kernel.cpp</a> as an example.</p>
<ul class="simple">
<li><p>The first step is to prepare the input image data, by calling read_file_to_buf, the data buffer will be stored in input_img and the size of the input_img will be stored in yuv_size parameter. Prepare the two output buffer to receive the full size output data and resize output data from the device</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">input_img</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resize_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">OUT_RESIZE_WIDTH</span> <span class="o">*</span> <span class="n">OUT_RESIZE_HEIGHT</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">full_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">OUT_WIDTH</span> <span class="o">*</span> <span class="n">OUT_HEIGHT</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">yuv_size</span><span class="p">;</span>
    <span class="n">read_file_to_buf</span><span class="p">(</span><span class="s">&quot;test.yuv&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_img</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yuv_size</span><span class="p">);</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">out_buf_0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">resize_size</span><span class="p">);</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">out_buf_1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">full_size</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Second, create an instance of XilinxOcl initialize by the “dpu.xclbin” which is generated from IP integration.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>    <span class="n">xcl</span><span class="o">::</span><span class="n">XilinxOcl</span> <span class="n">xocl</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;DPU_XCLBIN_PATH&quot;</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">xocl</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;DPU_XCLBIN_PATH&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">xocl</span><span class="p">.</span><span class="n">initialize</span><span class="p">(</span><span class="s">&quot;/mnt/dpu.xclbin&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Thirdly, get the CommandQueue and Kernel from the instance of XilinxOcl.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>    <span class="n">cl</span><span class="o">::</span><span class="n">CommandQueue</span> <span class="n">q</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">get_command_queue</span><span class="p">();</span>
    <span class="n">cl</span><span class="o">::</span><span class="n">Kernel</span> <span class="n">krnl</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">(</span><span class="s">&quot;pre_processor&quot;</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Fourth, create buffers on device side.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// the input buffer on device side to store input yuv data</span>
    <span class="k">auto</span> <span class="n">imgToDevice</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">yuv_size</span><span class="p">,</span> <span class="n">CL_MEM_READ_ONLY</span><span class="p">);</span>
<span class="c1">// the  resize buffer on device side</span>
    <span class="k">auto</span> <span class="n">resizeFromDevice</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">resize_size</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">);</span>

<span class="c1">// the full size buffer on device side</span>
    <span class="k">auto</span> <span class="n">fullFromDevice</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">create_buffer</span><span class="p">(</span><span class="n">full_size</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The next step is to set args to kernel functions. Please note there are two arguments, the full size output image width and height, have been set the initial values with 1920 and 1080.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="n">imgToDevice</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="n">resizeFromDevice</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="n">fullFromDevice</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="n">IN_WIDTH</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>  <span class="n">IN_HEIGHT</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span>  <span class="n">OUT_RESIZE_WIDTH</span><span class="p">);</span>
<span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span>  <span class="n">OUT_RESIZE_HEIGHT</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>At last, enqueue the task and run it, wait for the task to complete, and the results will be stored in out_buf_0 and out_buf_1.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Enqueue Stage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">q</span><span class="p">.</span><span class="n">enqueueWriteBuffer</span><span class="p">(</span><span class="n">imgToDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yuv_size</span><span class="p">,</span> <span class="n">input_img</span><span class="p">);</span>

<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Task Stage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">q</span><span class="p">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">krnl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_sp</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Wait Stage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">clWaitForEvents</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">cl_event</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_sp</span><span class="p">);</span>


<span class="n">q</span><span class="p">.</span><span class="n">enqueueReadBuffer</span><span class="p">(</span><span class="n">resizeFromDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resize_size</span><span class="p">,</span> <span class="n">out_buf_0</span><span class="p">);</span>
<span class="n">q</span><span class="p">.</span><span class="n">enqueueReadBuffer</span><span class="p">(</span><span class="n">fullFromDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">out_buf_1</span><span class="p">);</span>

<span class="n">q</span><span class="p">.</span><span class="n">finish</span><span class="p">();</span>
</pre></div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="how-to-migrate-from-opencv-to-hls-kernel">
<h1>How to migrate from OpenCV to HLS kernel.<a class="headerlink" href="#how-to-migrate-from-opencv-to-hls-kernel" title="Permalink to this headline">¶</a></h1>
<p>The V4l2Capture class contains the method read_images_with_kernel() for color conversion and image resizing, which is implemented in another method read_images() using OpenCV.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>        <span class="cm">/**</span>
<span class="cm">         * @brief Using HLS kernel to decode the yuv data and do resize</span>
<span class="cm">         * </span>
<span class="cm">         * @param readImage output parameters</span>
<span class="cm">         * @return int </span>
<span class="cm">         */</span>
        <span class="kt">int</span> <span class="nf">read_images_with_kernel</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">readImage</span><span class="p">);</span>

                <span class="cm">/**</span>
<span class="cm">         * @brief Read images from the device</span>
<span class="cm">         * </span>
<span class="cm">         * @param readImage and output parameters to store the image data.</span>
<span class="cm">         * @return int </span>
<span class="cm">         */</span>
       <span class="kt">int</span> <span class="nf">read_images</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="o">&gt;&amp;</span> <span class="n">readImage</span><span class="p">);</span>
</pre></div>
</div>
<p>The constructor of class V4l2Capture will using the xclbin to initialized the xocl, the instance of class xcl::XilinxOcl. The detail definition of XilinxOcl you can refer to <a class="reference external" href="../my_V4l2s/include/xcl2.hpp">xcl2.hpp</a></p>
<div class="highlight-C++ notranslate"><div class="highlight"><pre><span></span>V4l2Capture::V4l2Capture(V4l2Device *device) : V4l2Access(device)
{
    if (std::getenv(&quot;DPU_XCLBIN_PATH&quot;))
    {
        xocl.initialize(std::getenv(&quot;DPU_XCLBIN_PATH&quot;));
    }
    else
    {
        xocl.initialize(&quot;/mnt/dpu.xclbin&quot;);
    }
}
Get the command queue and create the buffers 
```c++
                q = xocl.get_command_queue();
                imgToDevice = xocl.create_buffer(rsize, CL_MEM_READ_ONLY);
                resizeFromDevice = xocl.create_buffer(resize_size, CL_MEM_WRITE_ONLY);
                fullFromDevice = xocl.create_buffer(full_size, CL_MEM_WRITE_ONLY);
</pre></div>
</div>
<p>Set the arguments to kernel, imgToDevice is the buffer to store the input image data get from the USB camera. resizeFromDevice is the buffer to store the resize image data on device side. The fullFromDevice is the buffer to store the full image(1080P) data on device side.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>                <span class="n">krnl</span> <span class="o">=</span> <span class="n">xocl</span><span class="p">.</span><span class="n">get_kernel</span><span class="p">(</span><span class="s">&quot;pre_processor&quot;</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">imgToDevice</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">resizeFromDevice</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">fullFromDevice</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">IN_WIDTH</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">IN_HEIGHT</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">OUT_RESIZE_WIDTH</span><span class="p">);</span>
                <span class="n">krnl</span><span class="p">.</span><span class="n">setArg</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">OUT_RESIZE_HEIGHT</span><span class="p">);</span>
                <span class="n">xocl_initialized</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
             <span class="p">}</span>
</pre></div>
</div>
<p>write the image data which store in (void*) buffer to imgToDevice, then enqueueTask to run the kernel function.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>            <span class="n">q</span><span class="p">.</span><span class="n">enqueueWriteBuffer</span><span class="p">(</span><span class="n">imgToDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsize</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>

            <span class="n">q</span><span class="p">.</span><span class="n">enqueueTask</span><span class="p">(</span><span class="n">krnl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_sp</span><span class="p">);</span>

            <span class="n">clWaitForEvents</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">cl_event</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_sp</span><span class="p">);</span>
</pre></div>
</div>
<p>Read the full resize image buffer to out_buf_0 and the full size image buffer to out_buf_1.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>            <span class="n">q</span><span class="p">.</span><span class="n">enqueueReadBuffer</span><span class="p">(</span><span class="n">resizeFromDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">resize_size</span><span class="p">,</span> <span class="n">out_buf_0</span><span class="p">);</span>
            <span class="n">q</span><span class="p">.</span><span class="n">enqueueReadBuffer</span><span class="p">(</span><span class="n">fullFromDevice</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">full_size</span><span class="p">,</span> <span class="n">out_buf_1</span><span class="p">);</span>
</pre></div>
</div>
<p>Convert the data into cv::Mat format, and push to the vector container of readImage.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>            <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">roi_mat0</span><span class="p">(</span><span class="n">OUT_RESIZE_HEIGHT</span><span class="p">,</span> <span class="n">OUT_RESIZE_WIDTH</span><span class="p">,</span> <span class="n">CV_8UC3</span><span class="p">,</span> <span class="n">out_buf_0</span><span class="p">);</span>
            <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">roi_mat1</span><span class="p">(</span><span class="n">OUT_HEIGHT</span><span class="p">,</span> <span class="n">OUT_WIDTH</span><span class="p">,</span> <span class="n">CV_8UC3</span><span class="p">,</span> <span class="n">out_buf_1</span><span class="p">);</span>
            <span class="n">readImage</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">roi_mat1</span><span class="p">);</span>
            <span class="n">readImage</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">roi_mat0</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;DONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p align="center"><sup>Copyright&copy; 2020 Xilinx</sup></p></div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
															</div>
														</div>
														<div class="col-md-pull-6 col-lg-pull-6 col-md-6 col-lg-6">
															<span class="copyright">
                                  
                                  &copy; 2020–2021, Xilinx, Inc.
                              </span>
															<ul class="list-inline sub-menu">
																<li>
																	<a href="https://www.xilinx.com/about/privacy-policy.html">Privacy</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/legal.html">Legal</a>
																</li>
																<li>
																	<a href="https://www.xilinx.com/about/contact.html">Contact</a>
																</li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
				<div class="quicklinks parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<noindex>
						<span class="quickLinks">
							<ul>
								<li>
									<a href="#top" class="btn backToTop">
									<span class="fas fa-angle-up" aria-hidden="true"></span>
									</a>
								</li>
							</ul>
						</span>
					</noindex>
				</div>
			</div>
		</div>
		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>